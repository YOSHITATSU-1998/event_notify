// screenshots/capture.js - GitHub Pages ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

async function captureScreenshot() {
    console.log('ðŸ“¸ Starting screenshot capture...');
    
    // ä»Šæ—¥ã®æ—¥ä»˜å–å¾— (JST)
    const now = new Date();
    const jstOffset = 9 * 60; // JST is UTC+9
    const jstTime = new Date(now.getTime() + jstOffset * 60000);
    const today = jstTime.toISOString().split('T')[0]; // YYYY-MM-DD
    
    console.log(`ðŸ“… Target date: ${today}`);
    
    // GitHub Pages URL
    const url = 'https://yoshitatsu-1998.github.io/event_notify/';
    console.log(`ðŸŒ Target URL: ${url}`);
    
    let browser;
    try {
        // ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
        browser = await chromium.launch({
            headless: true,
            args: [
                '--no-sandbox',
                '--disable-dev-shm-usage',
                '--disable-web-security',
                '--font-render-hinting=none',
                '--disable-font-subpixel-positioning'
            ]
        });
        
        const page = await browser.newPage();
        
        // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºè¨­å®šï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤ºï¼‰
        await page.setViewportSize({ width: 1200, height: 800 });
        
        console.log('ðŸ” Navigating to page...');
        
        // ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
        await page.goto(url, { 
            waitUntil: 'networkidle',
            timeout: 30000 
        });
        
        // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚’å¾…æ©Ÿ
        await page.waitForTimeout(5000);
        
        // Web ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºèª
        await page.waitForFunction(() => {
            return document.fonts.ready;
        }, { timeout: 10000 });
        
        console.log('âœ… Fonts loaded successfully');
        
        // è¿½åŠ ã®å®‰å®šåŒ–å¾…æ©Ÿ
        await page.waitForTimeout(2000);
        
        // screenshots ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        const screenshotsDir = path.dirname(__filename);
        if (!fs.existsSync(screenshotsDir)) {
            fs.mkdirSync(screenshotsDir, { recursive: true });
        }
        
        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
        const screenshotPath = path.join(screenshotsDir, `${today}.jpeg`);
        
        console.log(`ðŸ’¾ Saving screenshot to: ${screenshotPath}`);
        
        await page.screenshot({
            path: screenshotPath,
            type: 'jpeg',
            quality: 90,
            fullPage: true
        });
        
        console.log('âœ… Screenshot captured successfully!');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
        const stats = fs.statSync(screenshotPath);
        const fileSizeKB = Math.round(stats.size / 1024);
        console.log(`ðŸ“Š File size: ${fileSizeKB} KB`);
        
    } catch (error) {
        console.error('âŒ Error capturing screenshot:', error);
        process.exit(1);
    } finally {
        if (browser) {
            await browser.close();
            console.log('ðŸ”’ Browser closed');
        }
    }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
if (require.main === module) {
    captureScreenshot()
        .then(() => {
            console.log('ðŸŽ‰ Screenshot capture completed!');
            process.exit(0);
        })
        .catch((error) => {
            console.error('ðŸ’¥ Fatal error:', error);
            process.exit(1);
        });
}

module.exports = { captureScreenshot };
