name: Daily Scraper & Dispatch Ver.3.0 - æ­£å¼é‹ç”¨
on:
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type to run'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - pages-only
          - slack-only
  schedule:
    - cron: '30 15 * * *'   # JST 00:30 - Pagesæ›´æ–° + Slacké€šçŸ¥ï¼ˆçµ±ä¸€ï¼‰

jobs:
  unified-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # â† ã“ã“ã‚’ read ã‹ã‚‰ write ã«å¤‰æ›´ï¼ˆé‡è¦ï¼ï¼‰
      pages: write
      id-token: write
    env:
      TZ: Asia/Tokyo
      PYTHONPATH: ${{ github.workspace }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
      MANUAL_PASSWORD: ${{ secrets.MANUAL_PASSWORD }}
      ENABLE_DB_SAVE: "1"
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      GITHUB_PAGES: "true"
    
    steps:
      - uses: actions/checkout@v4
        with:
          path: event_notify
          token: ${{ secrets.GITHUB_TOKEN }}  # â† è¿½åŠ ï¼ˆè‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç”¨ï¼‰
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f event_notify/requirements.txt ]; then pip install -r event_notify/requirements.txt; fi
      
      # Ver.2.0: Supabaseä¾å­˜é–¢ä¿‚è¿½åŠ 
      - name: Install Ver.2.0 dependencies
        run: |
          pip install supabase>=1.0.0
          pip install python-dotenv>=0.19.0
          pip install python-dateutil>=2.8.0
      
      - name: Ensure __init__.py files
        run: |
          touch event_notify/__init__.py
          touch event_notify/scrapers/__init__.py
          touch event_notify/utils/__init__.py
          touch event_notify/notify/__init__.py
          touch event_notify/scripts/__init__.py
      
      - name: Debug environment
        run: |
          echo "Working directory: $(pwd)"
          echo "Ver.2.9 Environment Variables:"
          echo "PYTHONPATH: $PYTHONPATH"
          echo "ENABLE_DB_SAVE: $ENABLE_DB_SAVE"
          echo "SUPABASE_URL: ${SUPABASE_URL:0:20}..." # æœ€åˆ20æ–‡å­—ã®ã¿è¡¨ç¤º
          echo "Directory structure:"
          ls -la event_notify/
          python -c "import sys; print('Python path:', sys.path)"
      
      - name: Refresh future events (Ver.2.9 - unified scraping + DB transaction)
        run: |
          set -e
          echo "ğŸ”„ Ver.2.9 ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–‹å§‹ - $(date)"
          cd event_notify
          python -m scripts.refresh_future_events
          echo "âœ… Ver.2.9 ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ENABLE_DB_SAVE: "1"
          TZ: Asia/Tokyo
      
      - name: Generate HTML for web (index.html + manual.html)
        run: |
          set -e
          echo "ğŸ“„ HTMLç”Ÿæˆé–‹å§‹"
          mkdir -p site
          cd event_notify
          python -m notify.html_export
          cp -r site/* ../site/
          ls -la ../site/
          echo "âœ… HTMLç”Ÿæˆå®Œäº†"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ENABLE_DB_SAVE: "1"
          TZ: Asia/Tokyo
      
      - name: Replace password in manual.html
        run: |
          echo "ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç½®æ›é–‹å§‹"
          if [ -f site/manual.html ]; then
            sed -i "s/PLACEHOLDER_PASSWORD/${{ secrets.MANUAL_PASSWORD }}/g" site/manual.html
            echo "âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç½®æ›å®Œäº†"
          else
            echo "âŒ manual.html not found"
            ls -la site/
          fi
        env:
          MANUAL_PASSWORD: ${{ secrets.MANUAL_PASSWORD }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # ============================================================
      # âœ¨ æ–°è¦è¿½åŠ : Gitè¨­å®šï¼ˆè‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç”¨ï¼‰
      # ============================================================
      - name: Configure Git for auto-commit
        run: |
          cd event_notify
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Setup Node.js for screenshot
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
      
      - name: Create package.json if not exists
        run: |
          cd event_notify
          if [ ! -f package.json ]; then
            echo '{"name": "event_notify_screenshots", "version": "1.0.0", "dependencies": {"playwright": "^1.40.0"}}' > package.json
          fi
      
      - name: Install Node.js dependencies and Playwright
        run: |
          cd event_notify
          npm install
          npx playwright install chromium
      
      - name: Take screenshot for audit log
        run: |
          cd event_notify
          echo "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—é–‹å§‹ - $(date)"
          node screenshots/capture.js
          echo "âœ… ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—å®Œäº†"
      
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-screenshot-${{ github.run_number }}
          path: event_notify/screenshots/*.jpeg
          retention-days: 90
      
      - name: Prepare manual events for dispatch
        run: |
          echo "ğŸ“ æ‰‹å‹•ã‚¤ãƒ™ãƒ³ãƒˆæº–å‚™"
          cd event_notify
          mkdir -p manual_events
          if [ ! -f manual_events/oneshot.json ]; then
            echo "[]" > manual_events/oneshot.json
          fi
          if [ ! -f manual_events/recurring.json ]; then
            echo "[]" > manual_events/recurring.json
          fi
          echo "ğŸ“‚ Manual events directory ready"
      
      - name: Get Pages URL for notification
        run: |
          REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          echo "GITHUB_PAGES_URL=https://${REPO_OWNER}.github.io/${REPO_NAME}/" >> $GITHUB_ENV
      
      - name: Dispatch notification (0:30 unified schedule)
        run: |
          set -e
          echo "ğŸ“¢ çµ±ä¸€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥é–‹å§‹ - $(date)"
          cd event_notify
          python -m notify.dispatch
          echo "âœ… çµ±ä¸€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥å®Œäº†"
        env:
          GITHUB_PAGES_URL: ${{ env.GITHUB_PAGES_URL }}
      
      # ============================================================
      # âœ¨ æ–°è¦è¿½åŠ : è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆï¼ˆ60æ—¥é–“åœæ­¢é˜²æ­¢ï¼‰
      # ============================================================
      - name: Auto-commit to prevent workflow disabling
        run: |
          cd event_notify
          echo "ğŸ”„ è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œï¼ˆ60æ—¥é–“åœæ­¢é˜²æ­¢ï¼‰"
          
          # æœ€çµ‚å®Ÿè¡Œæ—¥æ™‚ã‚’è¨˜éŒ²
          CURRENT_DATE=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          echo "Last automated run: ${CURRENT_DATE}" > .github/LAST_RUN.txt
          echo "Workflow run number: ${{ github.run_number }}" >> .github/LAST_RUN.txt
          echo "Ver.3.0 - æ­£å¼é‹ç”¨" >> .github/LAST_RUN.txt
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          git add .github/LAST_RUN.txt
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "Auto-update: Daily scraper run #${{ github.run_number }} - ${CURRENT_DATE}"
            git push
            echo "âœ… è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Œäº†: ${CURRENT_DATE}"
          fi
      
      - name: Ver.3.0 completion log
        run: |
          echo "ğŸ‰ Ver.3.0 å®Ÿè¡Œå®Œäº† - $(date)"
          echo "ğŸ“± Pages URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“Š å¯¾å¿œä¼šå ´: 8ä¼šå ´ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ–¹å¼ï¼‰"
          echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°å®Œäº†"
          echo "ğŸ”„ é‡å­ç¢ºå®šç†è«–: éå»ç¢ºå®šãƒ»æœªæ¥ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"
          echo "ğŸ“ æ‰‹å‹•ã‚¤ãƒ™ãƒ³ãƒˆ: å®Œå…¨ä¿è­·"
          echo "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ: daily-screenshot-${{ github.run_number }}"
          echo "â° çµ±ä¸€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: 0:30 JST (ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“åŸºæº–)"
          echo "ğŸ” è‡ªå‹•åœæ­¢é˜²æ­¢: .github/LAST_RUN.txt è‡ªå‹•æ›´æ–°"
