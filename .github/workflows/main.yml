name: Daily Scraper & Dispatch Ver.3.1.2 - ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥å®Ÿè£…
on:
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type to run'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - pages-only
          - slack-only
  schedule:
    - cron: '37 15 * * *'   # JST 00:37 - ä¸­é€”åŠç«¯ãªæ™‚åˆ»ã§æ··é›‘å›é¿

jobs:
  unified-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç”¨
      pages: write         # Pages ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨
      id-token: write      # Pages ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ï¼ˆå¿…é ˆï¼‰
    env:
      TZ: Asia/Tokyo
      PYTHONPATH: ${{ github.workspace }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
      MANUAL_PASSWORD: ${{ secrets.MANUAL_PASSWORD }}
      ENABLE_DB_SAVE: "1"
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      GITHUB_PAGES: "true"
    
    steps:
      - uses: actions/checkout@v4
        with:
          path: event_notify
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f event_notify/requirements.txt ]; then pip install -r event_notify/requirements.txt; fi
      
      # Ver.2.0: Supabaseä¾å­˜é–¢ä¿‚è¿½åŠ 
      - name: Install Ver.2.0 dependencies
        run: |
          pip install supabase>=1.0.0
          pip install python-dotenv>=0.19.0
          pip install python-dateutil>=2.8.0
      
      - name: Ensure __init__.py files
        run: |
          touch event_notify/__init__.py
          touch event_notify/scrapers/__init__.py
          touch event_notify/utils/__init__.py
          touch event_notify/notify/__init__.py
          touch event_notify/scripts/__init__.py
      
      - name: Debug environment
        run: |
          echo "Working directory: $(pwd)"
          echo "Ver.3.1.2 Environment Variables:"
          echo "PYTHONPATH: $PYTHONPATH"
          echo "ENABLE_DB_SAVE: $ENABLE_DB_SAVE"
          echo "SUPABASE_URL: ${SUPABASE_URL:0:20}..."
          echo "Directory structure:"
          ls -la event_notify/
          python -c "import sys; print('Python path:', sys.path)"
      
      - name: Refresh future events (Ver.2.9 - unified scraping + DB transaction)
        run: |
          set -e
          echo "ğŸ”„ Ver.3.1.2 ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–‹å§‹ - $(date)"
          cd event_notify
          python -m scripts.refresh_future_events
          echo "âœ… Ver.3.1.2 ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ENABLE_DB_SAVE: "1"
          TZ: Asia/Tokyo
      
      - name: Generate HTML for web (index.html + manual.html)
        run: |
          set -e
          echo "ğŸ“„ HTMLç”Ÿæˆé–‹å§‹"
          mkdir -p site
          cd event_notify
          python -m notify.html_export
          cp -r site/* ../site/
          ls -la ../site/
          echo "âœ… HTMLç”Ÿæˆå®Œäº†"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ENABLE_DB_SAVE: "1"
          TZ: Asia/Tokyo
      
      - name: Replace password in manual.html
        run: |
          echo "ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç½®æ›é–‹å§‹"
          if [ -f site/manual.html ]; then
            sed -i "s/PLACEHOLDER_PASSWORD/${{ secrets.MANUAL_PASSWORD }}/g" site/manual.html
            echo "âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç½®æ›å®Œäº†"
          else
            echo "âŒ manual.html not found"
            ls -la site/
          fi
        env:
          MANUAL_PASSWORD: ${{ secrets.MANUAL_PASSWORD }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
      
      # ============================================================
      # âœ¨ Ver.3.1.2 æ–°æ©Ÿèƒ½: 3å›ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥
      # ============================================================
      
      - name: Deploy to GitHub Pages (1st attempt)
        id: deployment_1
        uses: actions/deploy-pages@v4
        with:
          timeout: 900000  # 15åˆ†ï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
        continue-on-error: true
      
      - name: Wait before 2nd attempt
        if: steps.deployment_1.outcome == 'failure'
        run: |
          echo "â³ 1st attempt failed. Waiting 5 minutes before retry..."
          echo "ğŸ’¡ Reason: GitHub Pages deployment queue is congested"
          sleep 300
      
      - name: Deploy to GitHub Pages (2nd attempt)
        if: steps.deployment_1.outcome == 'failure'
        id: deployment_2
        uses: actions/deploy-pages@v4
        with:
          timeout: 900000  # 15åˆ†
        continue-on-error: true
      
      - name: Wait before 3rd attempt
        if: steps.deployment_2.outcome == 'failure'
        run: |
          echo "â³ 2nd attempt failed. Waiting 10 minutes before final retry..."
          echo "ğŸ’¡ Queue should be clear after 15 minutes total wait"
          sleep 600
      
      - name: Deploy to GitHub Pages (3rd attempt - FINAL)
        if: steps.deployment_2.outcome == 'failure'
        id: deployment_3
        uses: actions/deploy-pages@v4
        with:
          timeout: 1200000  # 20åˆ†ï¼ˆæœ€çµ‚è©¦è¡Œã¯ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼‰
      
      - name: Verify deployment success
        run: |
          echo "ğŸ” Checking deployment results..."
          
          if [ "${{ steps.deployment_1.outcome }}" == "success" ]; then
            echo "âœ… Pages deployment succeeded (1st attempt)"
            echo "â±ï¸ Total time: ~15 minutes"
            echo "FINAL_DEPLOYMENT_URL=${{ steps.deployment_1.outputs.page_url }}" >> $GITHUB_ENV
            echo "DEPLOYMENT_ATTEMPT=1" >> $GITHUB_ENV
            echo "DEPLOYMENT_SUCCESS=true" >> $GITHUB_ENV
          elif [ "${{ steps.deployment_2.outcome }}" == "success" ]; then
            echo "âœ… Pages deployment succeeded (2nd attempt after 5min wait)"
            echo "â±ï¸ Total time: ~25 minutes (15min + 5min wait + 15min)"
            echo "FINAL_DEPLOYMENT_URL=${{ steps.deployment_2.outputs.page_url }}" >> $GITHUB_ENV
            echo "DEPLOYMENT_ATTEMPT=2" >> $GITHUB_ENV
            echo "DEPLOYMENT_SUCCESS=true" >> $GITHUB_ENV
          elif [ "${{ steps.deployment_3.outcome }}" == "success" ]; then
            echo "âœ… Pages deployment succeeded (3rd attempt after 15min total wait)"
            echo "â±ï¸ Total time: ~50 minutes (15min + 5min + 15min + 10min + 20min)"
            echo "FINAL_DEPLOYMENT_URL=${{ steps.deployment_3.outputs.page_url }}" >> $GITHUB_ENV
            echo "DEPLOYMENT_ATTEMPT=3" >> $GITHUB_ENV
            echo "DEPLOYMENT_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ All 3 deployment attempts failed"
            echo "âŒ Total wait time: 15 minutes"
            echo "âŒ Total timeout time: 50 minutes"
            echo "ğŸ’¡ Recommendation: Try running manually later"
            echo "DEPLOYMENT_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi
      
      # ============================================================
      # Gitè¨­å®šï¼ˆè‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç”¨ï¼‰
      # ============================================================
      - name: Configure Git for auto-commit
        run: |
          cd event_notify
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Setup Node.js for screenshot
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
      
      - name: Create package.json if not exists
        run: |
          cd event_notify
          if [ ! -f package.json ]; then
            echo '{"name": "event_notify_screenshots", "version": "1.0.0", "dependencies": {"playwright": "^1.40.0"}}' > package.json
          fi
      
      - name: Install Node.js dependencies and Playwright
        run: |
          cd event_notify
          npm install
          npx playwright install chromium
      
      - name: Take screenshot for audit log
        run: |
          cd event_notify
          echo "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—é–‹å§‹ - $(date)"
          node screenshots/capture.js
          echo "âœ… ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—å®Œäº†"
      
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-screenshot-${{ github.run_number }}
          path: event_notify/screenshots/*.jpeg
          retention-days: 90
      
      - name: Prepare manual events for dispatch
        run: |
          echo "ğŸ“ æ‰‹å‹•ã‚¤ãƒ™ãƒ³ãƒˆæº–å‚™"
          cd event_notify
          mkdir -p manual_events
          if [ ! -f manual_events/oneshot.json ]; then
            echo "[]" > manual_events/oneshot.json
          fi
          if [ ! -f manual_events/recurring.json ]; then
            echo "[]" > manual_events/recurring.json
          fi
          echo "ğŸ“‚ Manual events directory ready"
      
      # ============================================================
      # âœ¨ Ver.3.1.2 ä¿®æ­£: çµ±ä¸€ã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨
      # ============================================================
      - name: Get Pages URL for notification
        run: |
          echo "ğŸ“± Setting Pages URL for Slack notification"
          echo "GITHUB_PAGES_URL=${{ env.FINAL_DEPLOYMENT_URL }}" >> $GITHUB_ENV
      
      - name: Dispatch notification (0:37 unified schedule)
        run: |
          set -e
          echo "ğŸ“¢ çµ±ä¸€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥é–‹å§‹ - $(date)"
          cd event_notify
          python -m notify.dispatch
          echo "âœ… çµ±ä¸€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥å®Œäº†"
        env:
          GITHUB_PAGES_URL: ${{ env.GITHUB_PAGES_URL }}
      
      # ============================================================
      # è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆï¼ˆ60æ—¥é–“åœæ­¢é˜²æ­¢ï¼‰
      # ============================================================
      - name: Auto-commit to prevent workflow disabling
        run: |
          cd event_notify
          echo "ğŸ”„ è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œï¼ˆ60æ—¥é–“åœæ­¢é˜²æ­¢ï¼‰"
          
          # æœ€çµ‚å®Ÿè¡Œæ—¥æ™‚ã‚’è¨˜éŒ²
          CURRENT_DATE=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          echo "Last automated run: ${CURRENT_DATE}" > .github/LAST_RUN.txt
          echo "Workflow run number: ${{ github.run_number }}" >> .github/LAST_RUN.txt
          echo "Ver.3.1.2 - ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥å®Ÿè£…" >> .github/LAST_RUN.txt
          echo "Deployment attempt: ${{ env.DEPLOYMENT_ATTEMPT }}" >> .github/LAST_RUN.txt
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          git add .github/LAST_RUN.txt
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "Auto-update: Daily scraper run #${{ github.run_number }} - ${CURRENT_DATE} [skip ci]"
            git push
            echo "âœ… è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Œäº†: ${CURRENT_DATE}"
          fi
      
      # ============================================================
      # âœ¨ Ver.3.1.2 ä¿®æ­£: ãƒ‡ãƒ—ãƒ­ã‚¤è©¦è¡Œå›æ•°ã‚’å«ã‚€å®Œäº†ãƒ­ã‚°
      # ============================================================
      - name: Ver.3.1.2 completion log
        run: |
          echo "ğŸ‰ Ver.3.1.2 å®Ÿè¡Œå®Œäº† - $(date)"
          echo "ğŸ“± Pages URL: ${{ env.FINAL_DEPLOYMENT_URL }}"
          echo "ğŸ”„ Deployment succeeded on attempt #${{ env.DEPLOYMENT_ATTEMPT }}"
          echo "ğŸ“Š å¯¾å¿œä¼šå ´: 8ä¼šå ´ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ–¹å¼ï¼‰"
          echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°å®Œäº†"
          echo "ğŸ”„ é‡å­ç¢ºå®šç†è«–: éå»ç¢ºå®šãƒ»æœªæ¥ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"
          echo "ğŸ“ æ‰‹å‹•ã‚¤ãƒ™ãƒ³ãƒˆ: å®Œå…¨ä¿è­·"
          echo "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ: daily-screenshot-${{ github.run_number }}"
          echo "â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: JST 00:37ï¼ˆä¸­é€”åŠç«¯ãªæ™‚åˆ»ã§æ··é›‘å›é¿ï¼‰"
          echo "ğŸ” è‡ªå‹•åœæ­¢é˜²æ­¢: .github/LAST_RUN.txt è‡ªå‹•æ›´æ–°"
          echo "â™»ï¸ ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥: æœ€å¤§3å›ï¼ˆ5åˆ†ãƒ»10åˆ†å¾…æ©Ÿï¼‰"
